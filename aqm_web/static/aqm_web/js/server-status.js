// Generated by CoffeeScript 1.3.1
(function() {
  var cpu_data, max_cpu_data, num, set_cpu_label, setup_server_auto_update, update_cpu_graph, update_server;

  max_cpu_data = 100;

  cpu_data = (function() {
    var _i, _results;
    _results = [];
    for (num = _i = 1; _i <= 100; num = ++_i) {
      _results.push(0);
    }
    return _results;
  })();

  $(document).ready(function() {
    return $(".sparkline-chart .inner-graph").sparkline(cpu_data, {
      width: '80%'
    });
  });

  update_cpu_graph = function(id, cpu) {
    cpu_data.push(cpu);
    if (cpu_data.length > max_cpu_data) {
      cpu_data.splice(0, 1);
    }
    $("#cpu-usage-server-" + id + " .inner-graph").sparkline(cpu_data, {
      width: '85%'
    });
    return $("#cpu-usage-server-" + id + " .inner-text").text("" + cpu + "%");
  };

  set_cpu_label = function(id, label) {
    return $("#cpu-usage-server-" + id + " .inner-text").text("" + label);
  };

  window.setup_server_list_auto_update = function(server_list, interval) {
    var server, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = server_list.length; _i < _len; _i++) {
      server = server_list[_i];
      _results.push(setup_server_auto_update(server, interval));
    }
    return _results;
  };

  setup_server_auto_update = function(server, interval) {
    var timer, updater;
    updater = function(server) {
      return $.ajax({
        url: server.get_status_rest_url,
        dataType: "json",
        type: "GET",
        success: update_server,
        error: function(jqXHR, textStatus, errorThrown) {
          console.log(errorThrown, jqXHR);
          if (jqXHR.status === 0) {
            $("#server_" + server.id + " > .header > .label.status").text("check your internet connection");
          } else if (jqXHR.status === 404) {
            $("#server_" + server.id + " > .header > .label.status").text("server does not exist");
          } else if (jqXHR.status === 500) {
            $("#server_" + server.id + " > .header > .label.status").text("internal web server error");
          } else if (jqXHR.status === 503) {
            $("#server_" + server.id + " > .header > .label.status").text("service disruption");
          }
          $("#server_" + server.id + " > .header > .label.status").removeClass("label-success").addClass("label-important");
          update_cpu_graph(server.id, 0);
          set_cpu_label(server.id, "--");
          simplebar.set("#memory-usage-server-" + server.id, 0, "--");
          simplebar.set("#disk-usage-server-" + server.id, 0, "--");
          return simplebar.set("#slot-usage-server-" + server.id, 0, "--");
        }
      });
    };
    return timer = setInterval(function() {
      return updater(server);
    }, interval);
  };

  update_server = function(server_stat) {
    var disk_label, disk_total, disk_used, memory_label, memory_total, memory_used, slot_label, slot_percent;
    update_cpu_graph(server_stat.id, server_stat.cpu);
    memory_used = Math.round(server_stat.memory_used / (1024 * 1024));
    memory_total = Math.round(server_stat.memory_total / (1024 * 1024));
    memory_label = "" + memory_used + " MB / " + memory_total + " MB";
    simplebar.set("#memory-usage-server-" + server_stat.id, server_stat.memory_percent, memory_label);
    disk_used = Math.round(server_stat.disk_used / (1024 * 1024 * 1024));
    disk_total = Math.round(server_stat.disk_total / (1024 * 1024 * 1024));
    disk_label = "" + disk_used + " GB / " + disk_total + " GB";
    simplebar.set("#disk-usage-server-" + server_stat.id, server_stat.disk_percent, disk_label);
    slot_percent = (server_stat.slot_used / server_stat.slot_total) * 100;
    slot_label = "" + server_stat.slot_used + " of " + server_stat.slot_total;
    simplebar.set("#slot-usage-server-" + server_stat.id, slot_percent, slot_label);
    $("#server_" + server_stat.id + " > .header > .label.status").text("healthy");
    return $("#server_" + server_stat.id + " > .header > .label.status").removeClass("label-important").addClass("label-success");
  };

}).call(this);
