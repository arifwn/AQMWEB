<script>
{% load url from future %}

$(document).ready(function () {
	var timer = setInterval(function(){
		
        {% for server in servers %}
		$.ajax({url: "{% url 'rest-server-utilization' server.pk %}",
				dataType: 'json',
                type: 'GET',
				success: function(data){
					var cpu = data['cpu'];
					var cpu_label = cpu + '%';
					simplebar.set('#cpu-usage-server-{{ server.pk }}', cpu, cpu_label);
					
                    var mem_used = data['memory_used'];
					var mem_total = data['memory_total'];
					var mem_percent = data['memory_percent'];
					var label = Math.round(mem_used / (1024 * 1024)) + 'MB / ' + Math.round(mem_total / (1024 * 1024)) + 'MB';
					simplebar.set('#memory-usage-server-{{ server.pk }}', mem_percent, label);
					
                    var disk_used = data['disk_used'];
					var disk_total = data['disk_total'];
					var disk_percent = data['disk_percent'];
					var label = Math.round(disk_used / (1024 * 1024 * 1024)) + 'GB / ' + Math.round(disk_total / (1024 * 1024 * 1024)) + 'GB';
					simplebar.set('#disk-usage-server-{{ server.pk }}', disk_percent, label);
					
					$('#server_{{ server.pk }} > .header > .label').text('healthy');
					$('#server_{{ server.pk }} > .header > .label').removeClass('label-important').addClass('label-success');
					},
				error: function(jqXHR, textStatus, errorThrown){
					if(errorThrown==='INTERNAL SERVER ERROR'){
						$('#server_{{ server.pk }} > .header > .label').text('service disruption');
						$('#server_{{ server.pk }} > .header > .label').removeClass('label-success').addClass('label-important');
						simplebar.set('#cpu-usage-server-{{ server.pk }}', 0, '--');
						simplebar.set('#memory-usage-server-{{ server.pk }}', 0, '--');
						simplebar.set('#disk-usage-server-{{ server.pk }}', 0, '--');
					}
				}
		});
		{% endfor %}
		
	}, 2500);
});
</script>

<div class="row"> 
	<div class="span12">
		<div class="well">
			<div>
				<h1>Server Status</h1>
			</div>

			<div class="row">
				<div class="span6">
                    {% for server in servers %}
                    <div id="server_{{ server.pk }}" class="server-status">
						<div class="header">
							<h2>{{ server.name }} <small>{{ server.address }}:{{ server.port }}</small></h2>
							<span class="label">loading...</span>
						</div>
						<div class="content">
							<table>
								<tbody>
									<tr>
										<th>Current CPU Usage</th>
										<td>
											<div id="cpu-usage-server-{{ server.pk }}" class="color-green medium" data-simplebar="simplebar" data-simplebar-percentage="0" 
											data-simplebar-text="loading..."></div>
										</td>
									</tr>
									<tr>
										<th>Current Memory Usage</th>
										<td>
											<div id="memory-usage-server-{{ server.pk }}" class="color-blue medium" data-simplebar="simplebar" data-simplebar-percentage="0" 
											data-simplebar-text="loading..."></div>
										</td>
									</tr>
									<tr>
										<th>Current Disk Usage</th>
										<td>
											<div id="disk-usage-server-{{ server.pk }}" class="color-red medium" data-simplebar="simplebar" data-simplebar-percentage="0"
                                            data-simplebar-text="loading..."></div>
										</td>
									</tr>
									<tr>
										<th>Slot Utilization</th>
										<td>
											<div class="bar-chart medium">
												<div class="inner-bar">
													<div class="bar" style="width: 100%"></div>
												</div>
												<div class="inner-text">4 of 4</div>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
                    {% endfor %}
                    
				</div>
				<div class="span5">
					<table class="table table-striped table-bordered table-condensed" style="background: white;">
						<tbody>
							<tr>
								<th>Currently Running Task</th>
								<td>8</td>
							</tr>
							<tr>
								<th>Pending Tasks</th>
								<td>13</td>
							</tr>
							<tr>
								<th>Current Longest Task</th>
								<td>24 hour 55 minutes</td>
							</tr>
							<tr>
								<th>Biggest Task</th>
								<td>4.2 Gb</td>
							</tr>
							<tr>
								<th>Task Slot Capacity</th>
								<td>8</td>
							</tr>
							<tr>
								<th>Modelling Server Available</th>
								<td>2</td>
							</tr>
							<tr>
								<th>Current Longest Uptime</th>
								<td>57 days 23 hours 14 minutes</td>
							</tr>
							<tr>
								<th>Current Shortest Uptime</th>
								<td>2 days 14 hours 43 minutes</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div> 
</div>

